<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本格野球ゲーム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a3a5c 0%, #2d5a8f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .game-container {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 800px;
            width: 100%;
            color: #fff;
        }
        h1 {
            color: #ffd700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* 設定画面 */
        .settings {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .settings h2 {
            margin-bottom: 15px;
            color: #ffd700;
        }
        .difficulty-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .diff-btn {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        .diff-btn.easy {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        .diff-btn.normal {
            background: linear-gradient(135deg, #f39c12, #f1c40f);
            color: #333;
        }
        .diff-btn.hard {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        .diff-btn.legend {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        .diff-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        /* スコアボード */
        .scoreboard {
            display: flex;
            justify-content: space-around;
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            border: 3px solid #333;
        }
        .score-item {
            text-align: center;
        }
        .score-item span {
            display: block;
            font-size: 11px;
            color: #888;
        }
        .score-item strong {
            font-size: 22px;
        }

        /* カウント */
        .count-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 10px 0;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
        }
        .count-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .count-item label {
            font-weight: bold;
            width: 20px;
        }
        .count-dots {
            display: flex;
            gap: 5px;
        }
        .dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #555;
        }
        .dot.ball { background: #27ae60; border-color: #2ecc71; }
        .dot.strike { background: #e74c3c; border-color: #c0392b; }
        .dot.out { background: #f39c12; border-color: #e67e22; }

        /* フィールド */
        .field-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin: 15px auto;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 40%, #4a9f5a 40%);
            border-radius: 15px;
            overflow: hidden;
            border: 3px solid #333;
        }

        /* 外野 */
        .outfield {
            position: absolute;
            width: 100%;
            height: 60%;
            top: 0;
            background: #4a9f5a;
            border-bottom-left-radius: 100% 50%;
            border-bottom-right-radius: 100% 50%;
        }

        /* ダイヤモンド */
        .diamond {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
        }
        .base {
            position: absolute;
            width: 15px;
            height: 15px;
            background: #fff;
            transform: rotate(45deg);
        }
        .home-plate {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 20px;
            height: 20px;
            background: #fff;
        }
        .first-base { right: 20px; bottom: 80px; }
        .second-base { left: 50%; bottom: 150px; transform: translateX(-50%) rotate(45deg); }
        .third-base { left: 20px; bottom: 80px; }

        /* ランナー */
        .runner {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #ff6b6b;
            border-radius: 50%;
            border: 2px solid #fff;
            display: none;
            z-index: 10;
        }
        .runner.on-first { display: block; right: 15px; bottom: 85px; }
        .runner.on-second { display: block; left: 50%; bottom: 155px; transform: translateX(-50%); }
        .runner.on-third { display: block; left: 15px; bottom: 85px; }

        /* ピッチャー */
        .pitcher {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 25px;
            background: #3498db;
            border-radius: 50%;
            border: 3px solid #fff;
        }

        /* バッター */
        .batter {
            position: absolute;
            bottom: 15px;
            left: calc(50% + 25px);
            width: 20px;
            height: 35px;
            background: #e74c3c;
            border-radius: 5px 5px 0 0;
        }
        .bat {
            position: absolute;
            bottom: 25px;
            left: calc(50% + 50px);
            width: 6px;
            height: 45px;
            background: linear-gradient(to top, #8B4513, #D2691E);
            transform-origin: bottom left;
            border-radius: 3px;
            transition: transform 0.1s;
        }
        .bat.swing {
            animation: batSwing 0.25s ease-out;
        }
        @keyframes batSwing {
            0% { transform: rotate(0deg); }
            40% { transform: rotate(-120deg); }
            100% { transform: rotate(0deg); }
        }

        /* ボール */
        .ball {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle at 30% 30%, #fff, #ccc);
            border-radius: 50%;
            display: none;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* 打球 */
        .hit-ball {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            display: none;
            z-index: 25;
        }

        /* 野手 */
        .fielder {
            position: absolute;
            width: 18px;
            height: 18px;
            background: #3498db;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        .fielder.lf { top: 80px; left: 80px; }
        .fielder.cf { top: 50px; left: 50%; transform: translateX(-50%); }
        .fielder.rf { top: 80px; right: 80px; }
        .fielder.ss { top: 180px; left: 180px; }
        .fielder.second-b { top: 180px; right: 180px; }
        .fielder.third-b { top: 220px; left: 120px; }
        .fielder.first-b { top: 220px; right: 120px; }
        .fielder.catcher-pos { bottom: 5px; left: 50%; transform: translateX(-50%); }

        .fielder.catching {
            animation: catchBall 0.3s ease-out;
        }
        @keyframes catchBall {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); background: #f1c40f; }
        }

        /* ストライクゾーン */
        .strike-zone-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 120px;
        }
        .strike-zone {
            width: 80px;
            height: 100px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            margin: 0 auto;
            position: relative;
            background: rgba(255,255,255,0.1);
        }
        .pitch-target {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #ff0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        .swing-target {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #0ff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
        }

        /* 球種表示 */
        .pitch-info {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
        }

        /* 結果表示 */
        .result-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            display: none;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px 30px;
            border-radius: 15px;
        }
        .result-display.hit { color: #2ecc71; }
        .result-display.out { color: #e74c3c; }
        .result-display.homerun { color: #f1c40f; }
        .result-display.ball { color: #3498db; }
        .result-display.strike { color: #e67e22; }

        /* メッセージ */
        .message {
            font-size: 18px;
            min-height: 30px;
            margin: 10px 0;
            color: #ffd700;
        }

        /* コントロール */
        .controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        .ready-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-size: 20px;
            padding: 15px 50px;
        }
        .ready-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 25px rgba(231, 76, 60, 0.5);
        }
        .ready-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .reset-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        .menu-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        /* 操作説明 */
        .instructions {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 14px;
            color: #aaa;
        }
        .instructions strong {
            color: #ffd700;
        }

        /* 難易度表示 */
        .current-difficulty {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
        }

        /* 球速表示 */
        .speed-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
        }

        .game-screen {
            display: none;
        }
        .game-screen.active {
            display: block;
        }

        /* 守備結果の詳細 */
        .play-detail {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>本格野球ゲーム</h1>

        <!-- 設定画面 -->
        <div class="settings game-screen active" id="settingsScreen">
            <h2>ピッチャーの強さを選択</h2>
            <div class="difficulty-buttons">
                <button class="diff-btn easy" onclick="startGame('easy')">
                    ルーキー<br><small>遅い球・変化少</small>
                </button>
                <button class="diff-btn normal" onclick="startGame('normal')">
                    レギュラー<br><small>普通の球速</small>
                </button>
                <button class="diff-btn hard" onclick="startGame('hard')">
                    エース<br><small>速球・変化球</small>
                </button>
                <button class="diff-btn legend" onclick="startGame('legend')">
                    レジェンド<br><small>魔球使い</small>
                </button>
            </div>
        </div>

        <!-- ゲーム画面 -->
        <div class="game-screen" id="gameScreen">
            <div class="scoreboard">
                <div class="score-item">
                    <span>スコア</span>
                    <strong id="score">0</strong>
                </div>
                <div class="score-item">
                    <span>イニング</span>
                    <strong id="inning">1</strong>
                </div>
                <div class="score-item">
                    <span>ヒット</span>
                    <strong id="hits">0</strong>
                </div>
            </div>

            <div class="count-display">
                <div class="count-item">
                    <label>B</label>
                    <div class="count-dots" id="ballDots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
                <div class="count-item">
                    <label>S</label>
                    <div class="count-dots" id="strikeDots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
                <div class="count-item">
                    <label>O</label>
                    <div class="count-dots" id="outDots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            </div>

            <div class="field-container" id="field">
                <div class="outfield"></div>

                <!-- 野手 -->
                <div class="fielder lf" id="lf"></div>
                <div class="fielder cf" id="cf"></div>
                <div class="fielder rf" id="rf"></div>
                <div class="fielder ss" id="ss"></div>
                <div class="fielder second-b" id="second-b"></div>
                <div class="fielder third-b" id="third-b"></div>
                <div class="fielder first-b" id="first-b"></div>
                <div class="fielder catcher-pos" id="catcher"></div>

                <div class="diamond">
                    <div class="base home-plate"></div>
                    <div class="base first-base"></div>
                    <div class="base second-base"></div>
                    <div class="base third-base"></div>
                    <div class="runner" id="runner1"></div>
                    <div class="runner" id="runner2"></div>
                    <div class="runner" id="runner3"></div>
                </div>

                <div class="pitcher" id="pitcher"></div>
                <div class="batter"></div>
                <div class="bat" id="bat"></div>

                <div class="strike-zone-container" id="szContainer">
                    <div class="strike-zone" id="strikeZone">
                        <div class="pitch-target" id="pitchTarget"></div>
                        <div class="swing-target" id="swingTarget"></div>
                    </div>
                </div>

                <div class="ball" id="ball"></div>
                <div class="hit-ball" id="hitBall"></div>

                <div class="pitch-info" id="pitchInfo"></div>
                <div class="speed-display" id="speedDisplay"></div>
                <div class="current-difficulty" id="diffDisplay"></div>
                <div class="result-display" id="resultDisplay"></div>
            </div>

            <div class="message" id="message">「構える」を押して投球を待て!</div>
            <div class="play-detail" id="playDetail"></div>

            <div class="controls">
                <button class="ready-btn" id="readyBtn" onclick="readyToBat()">構える</button>
                <button class="reset-btn" onclick="resetGame()">リセット</button>
                <button class="menu-btn" onclick="backToMenu()">メニュー</button>
            </div>

            <div class="instructions">
                <strong>操作方法:</strong> 「構える」→ ボールが来たら <strong>クリック/タップ</strong> でスイング!<br>
                タイミングと位置を合わせてヒットを狙え!
            </div>
        </div>
    </div>

    <script>
        // ゲーム状態
        let gameState = {
            score: 0,
            hits: 0,
            outs: 0,
            inning: 1,
            balls: 0,
            strikes: 0,
            bases: [false, false, false],
            difficulty: 'normal',
            isPlaying: false,
            isPitching: false,
            canSwing: false,
            gameOver: false
        };

        // 難易度設定
        const difficulties = {
            easy: {
                name: 'ルーキー',
                pitchSpeed: 2000,
                pitchTypes: ['ストレート', 'スローボール'],
                accuracy: 0.8,
                catchRate: 0.3,
                speedRange: [110, 125]
            },
            normal: {
                name: 'レギュラー',
                pitchSpeed: 1500,
                pitchTypes: ['ストレート', 'カーブ', 'スライダー'],
                accuracy: 0.7,
                catchRate: 0.45,
                speedRange: [130, 145]
            },
            hard: {
                name: 'エース',
                pitchSpeed: 1000,
                pitchTypes: ['ストレート', 'カーブ', 'スライダー', 'フォーク', 'チェンジアップ'],
                accuracy: 0.6,
                catchRate: 0.55,
                speedRange: [145, 158]
            },
            legend: {
                name: 'レジェンド',
                pitchSpeed: 700,
                pitchTypes: ['剛速球', 'カーブ', '高速スライダー', 'フォーク', 'チェンジアップ', '魔球'],
                accuracy: 0.5,
                catchRate: 0.65,
                speedRange: [155, 170]
            }
        };

        let currentPitch = null;
        let pitchTimeout = null;
        let swingTimeout = null;

        // DOM要素
        const elements = {
            ball: document.getElementById('ball'),
            hitBall: document.getElementById('hitBall'),
            bat: document.getElementById('bat'),
            strikeZone: document.getElementById('strikeZone'),
            pitchTarget: document.getElementById('pitchTarget'),
            swingTarget: document.getElementById('swingTarget'),
            pitchInfo: document.getElementById('pitchInfo'),
            speedDisplay: document.getElementById('speedDisplay'),
            diffDisplay: document.getElementById('diffDisplay'),
            resultDisplay: document.getElementById('resultDisplay'),
            message: document.getElementById('message'),
            playDetail: document.getElementById('playDetail'),
            readyBtn: document.getElementById('readyBtn'),
            field: document.getElementById('field')
        };

        // ゲーム開始
        function startGame(difficulty) {
            gameState = {
                score: 0,
                hits: 0,
                outs: 0,
                inning: 1,
                balls: 0,
                strikes: 0,
                bases: [false, false, false],
                difficulty: difficulty,
                isPlaying: true,
                isPitching: false,
                canSwing: false,
                gameOver: false
            };

            document.getElementById('settingsScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');

            elements.diffDisplay.textContent = difficulties[difficulty].name;
            updateDisplay();
            showMessage('「構える」を押して投球を待て!');
        }

        // メニューに戻る
        function backToMenu() {
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('settingsScreen').classList.add('active');
            resetState();
        }

        // 構える
        function readyToBat() {
            if (gameState.isPitching || gameState.gameOver) return;

            elements.readyBtn.disabled = true;
            elements.readyBtn.textContent = '投球中...';
            showMessage('ボールを見極めろ!');
            elements.playDetail.textContent = '';

            // 少し待ってから投球
            const waitTime = 500 + Math.random() * 1000;
            setTimeout(() => {
                pitch();
            }, waitTime);
        }

        // 投球
        function pitch() {
            gameState.isPitching = true;

            const diff = difficulties[gameState.difficulty];

            // 球種を選択
            const pitchType = diff.pitchTypes[Math.floor(Math.random() * diff.pitchTypes.length)];
            const speed = diff.speedRange[0] + Math.floor(Math.random() * (diff.speedRange[1] - diff.speedRange[0]));

            // 投球位置を決定
            const isStrike = Math.random() < diff.accuracy;
            let targetX, targetY;

            if (isStrike) {
                // ストライクゾーン内
                targetX = 15 + Math.random() * 50;
                targetY = 15 + Math.random() * 70;
            } else {
                // ボールゾーン
                const side = Math.floor(Math.random() * 4);
                switch(side) {
                    case 0: targetX = -20 + Math.random() * 30; targetY = Math.random() * 100; break;
                    case 1: targetX = 70 + Math.random() * 30; targetY = Math.random() * 100; break;
                    case 2: targetX = Math.random() * 80; targetY = -20 + Math.random() * 25; break;
                    case 3: targetX = Math.random() * 80; targetY = 95 + Math.random() * 25; break;
                }
            }

            currentPitch = {
                type: pitchType,
                speed: speed,
                targetX: targetX,
                targetY: targetY,
                isStrike: isStrike,
                movement: getPitchMovement(pitchType)
            };

            // 球種表示
            elements.pitchInfo.textContent = pitchType;
            elements.pitchInfo.style.display = 'block';
            elements.speedDisplay.textContent = speed + ' km/h';

            // ボールを表示してアニメーション
            const ball = elements.ball;
            ball.style.display = 'block';
            ball.style.left = '50%';
            ball.style.bottom = '280px';
            ball.style.transform = 'translate(-50%, 0) scale(0.3)';

            gameState.canSwing = true;

            // ボールの移動アニメーション
            const startTime = Date.now();
            const duration = diff.pitchSpeed;

            function animatePitch() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // 変化球の動き
                const movement = currentPitch.movement;
                const moveX = movement.x * progress * progress;
                const moveY = movement.y * progress * progress;

                const startBottom = 280;
                const endBottom = 45;
                const currentBottom = startBottom - (startBottom - endBottom) * progress;

                const zoneWidth = 80;
                const zoneHeight = 100;
                const finalX = (currentPitch.targetX / 100) * zoneWidth - zoneWidth/2;
                const currentX = moveX + finalX * progress;

                const scale = 0.3 + 0.7 * progress;

                ball.style.bottom = currentBottom + 'px';
                ball.style.left = `calc(50% + ${currentX}px)`;
                ball.style.transform = `translate(-50%, 0) scale(${scale})`;

                if (progress < 1 && gameState.isPitching) {
                    requestAnimationFrame(animatePitch);
                } else if (progress >= 1) {
                    // 投球完了
                    pitchComplete();
                }
            }

            requestAnimationFrame(animatePitch);

            // スイング可能時間
            pitchTimeout = setTimeout(() => {
                if (gameState.canSwing) {
                    gameState.canSwing = false;
                }
            }, duration);
        }

        // 球種による変化量
        function getPitchMovement(type) {
            switch(type) {
                case 'ストレート':
                case '剛速球':
                    return { x: 0, y: 0 };
                case 'カーブ':
                    return { x: -30 + Math.random() * 10, y: 20 };
                case 'スライダー':
                case '高速スライダー':
                    return { x: 25 + Math.random() * 15, y: 5 };
                case 'フォーク':
                    return { x: 0, y: 30 + Math.random() * 10 };
                case 'チェンジアップ':
                    return { x: -10 + Math.random() * 20, y: 15 };
                case 'スローボール':
                    return { x: 0, y: 5 };
                case '魔球':
                    return { x: -40 + Math.random() * 80, y: -20 + Math.random() * 50 };
                default:
                    return { x: 0, y: 0 };
            }
        }

        // 投球完了（振らなかった場合）
        function pitchComplete() {
            if (!gameState.isPitching) return;

            gameState.canSwing = false;
            elements.ball.style.display = 'none';

            if (currentPitch.isStrike) {
                // 見逃しストライク
                gameState.strikes++;
                if (gameState.strikes >= 3) {
                    showResult('三振!', 'strike');
                    showPlayDetail('見逃し三振');
                    recordOut();
                } else {
                    showResult('ストライク!', 'strike');
                    showPlayDetail('見逃し');
                }
            } else {
                // ボール
                gameState.balls++;
                if (gameState.balls >= 4) {
                    showResult('フォアボール!', 'ball');
                    showPlayDetail('四球で出塁');
                    walkBatter();
                } else {
                    showResult('ボール!', 'ball');
                    showPlayDetail('ボール球');
                }
            }

            finishPitch();
        }

        // スイング処理
        function handleSwing(e) {
            if (!gameState.canSwing || !gameState.isPitching) return;

            gameState.canSwing = false;
            clearTimeout(pitchTimeout);

            // バットを振る
            elements.bat.classList.add('swing');
            setTimeout(() => elements.bat.classList.remove('swing'), 250);

            // クリック位置を取得
            const rect = elements.strikeZone.getBoundingClientRect();
            const clickX = ((e.clientX - rect.left) / rect.width) * 100;
            const clickY = ((e.clientY - rect.top) / rect.height) * 100;

            // スイング位置表示
            elements.swingTarget.style.left = clickX + '%';
            elements.swingTarget.style.top = clickY + '%';
            elements.swingTarget.style.display = 'block';
            setTimeout(() => elements.swingTarget.style.display = 'none', 500);

            // 当たり判定
            const targetX = currentPitch.targetX;
            const targetY = currentPitch.targetY;

            const distance = Math.sqrt(
                Math.pow(clickX - targetX, 2) +
                Math.pow(clickY - targetY, 2)
            );

            elements.ball.style.display = 'none';

            // 結果判定
            if (distance < 20) {
                // ジャストミート
                handleHit(distance, clickX, clickY);
            } else if (distance < 35) {
                // かすった
                handleFoulOrWeakHit(distance);
            } else {
                // 空振り
                handleMiss();
            }

            finishPitch();
        }

        // ヒット処理
        function handleHit(distance, clickX, clickY) {
            const diff = difficulties[gameState.difficulty];
            const power = 1 - (distance / 20);
            const angle = Math.atan2(50 - clickY, clickX - 50);

            // 打球の方向と強さ
            const hitPower = 0.5 + power * 0.5 + Math.random() * 0.3;

            // 打球アニメーション
            showHitBall(angle, hitPower);

            // 守備判定
            setTimeout(() => {
                const catchChance = diff.catchRate * (1 - hitPower * 0.5);
                const isCaught = Math.random() < catchChance;

                if (hitPower > 0.9 && Math.random() < 0.3) {
                    // ホームラン
                    showResult('ホームラン!!', 'homerun');
                    const runs = advanceRunners(4) + 1;
                    gameState.score += runs;
                    gameState.hits++;
                    showPlayDetail(`打球はスタンドへ! ${runs}点!`);
                    resetCount();
                } else if (isCaught) {
                    // 守備にキャッチされた
                    const fielder = getFielderForAngle(angle, hitPower);
                    showFielderCatch(fielder);
                    showResult('アウト!', 'out');
                    showPlayDetail(`${fielder}がキャッチ!`);
                    recordOut();
                } else {
                    // ヒット
                    const hitType = getHitType(hitPower);
                    showResult(hitType.name + '!', 'hit');
                    const runs = advanceRunners(hitType.bases);
                    if (hitType.bases === 1) gameState.bases[0] = true;
                    else if (hitType.bases === 2) gameState.bases[1] = true;
                    else if (hitType.bases === 3) gameState.bases[2] = true;

                    gameState.score += runs;
                    gameState.hits++;

                    const detail = runs > 0 ? `${hitType.name}! ${runs}点追加!` : `${hitType.name}で出塁!`;
                    showPlayDetail(detail);
                    resetCount();
                }

                updateDisplay();
            }, 800);
        }

        // ヒットの種類
        function getHitType(power) {
            if (power > 0.85) return { name: '三塁打', bases: 3 };
            if (power > 0.7) return { name: '二塁打', bases: 2 };
            return { name: 'ヒット', bases: 1 };
        }

        // 野手の名前
        function getFielderForAngle(angle, power) {
            const deg = angle * 180 / Math.PI;
            if (power > 0.6) {
                if (deg < -30) return 'ライト';
                if (deg > 30) return 'レフト';
                return 'センター';
            } else {
                if (deg < -20) return 'ファースト';
                if (deg > 20) return 'サード';
                if (deg < 0) return 'セカンド';
                return 'ショート';
            }
        }

        // 野手キャッチ演出
        function showFielderCatch(fielder) {
            const fielderMap = {
                'レフト': 'lf', 'センター': 'cf', 'ライト': 'rf',
                'ショート': 'ss', 'セカンド': 'second-b',
                'サード': 'third-b', 'ファースト': 'first-b'
            };
            const el = document.getElementById(fielderMap[fielder]);
            if (el) {
                el.classList.add('catching');
                setTimeout(() => el.classList.remove('catching'), 500);
            }
        }

        // 打球アニメーション
        function showHitBall(angle, power) {
            const ball = elements.hitBall;
            ball.style.display = 'block';
            ball.style.left = '50%';
            ball.style.bottom = '50px';

            const distance = 100 + power * 200;
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;

            ball.animate([
                { left: '50%', bottom: '50px', transform: 'scale(1)' },
                { left: `calc(50% + ${endX}px)`, bottom: `${50 + endY}px`, transform: 'scale(0.3)' }
            ], {
                duration: 600,
                easing: 'ease-out'
            });

            setTimeout(() => ball.style.display = 'none', 600);
        }

        // ファウル/弱い当たり
        function handleFoulOrWeakHit(distance) {
            if (Math.random() < 0.6) {
                // ファウル
                if (gameState.strikes < 2) {
                    gameState.strikes++;
                }
                showResult('ファウル!', 'strike');
                showPlayDetail('ファウルボール');
            } else {
                // 弱いゴロ→アウト
                const fielder = ['ピッチャー', 'キャッチャー', 'ファースト'][Math.floor(Math.random() * 3)];
                showResult('アウト!', 'out');
                showPlayDetail(`${fielder}ゴロ`);
                recordOut();
            }
        }

        // 空振り
        function handleMiss() {
            gameState.strikes++;
            if (gameState.strikes >= 3) {
                showResult('三振!', 'strike');
                showPlayDetail('空振り三振!');
                recordOut();
            } else {
                showResult('空振り!', 'strike');
                showPlayDetail('空振り');
            }
        }

        // 投球終了
        function finishPitch() {
            gameState.isPitching = false;
            elements.pitchInfo.style.display = 'none';

            updateDisplay();

            setTimeout(() => {
                if (!gameState.gameOver) {
                    elements.readyBtn.disabled = false;
                    elements.readyBtn.textContent = '構える';
                    elements.resultDisplay.style.display = 'none';
                    showMessage('「構える」を押して次の投球を待て!');
                }
            }, 1500);
        }

        // 結果表示
        function showResult(text, type) {
            elements.resultDisplay.textContent = text;
            elements.resultDisplay.className = 'result-display ' + type;
            elements.resultDisplay.style.display = 'block';
        }

        // プレイ詳細
        function showPlayDetail(text) {
            elements.playDetail.textContent = text;
        }

        // メッセージ
        function showMessage(text) {
            elements.message.textContent = text;
        }

        // ランナー進塁
        function advanceRunners(bases) {
            let runs = 0;
            for (let i = 0; i < bases; i++) {
                if (gameState.bases[2]) { runs++; gameState.bases[2] = false; }
                if (gameState.bases[1]) { gameState.bases[2] = true; gameState.bases[1] = false; }
                if (gameState.bases[0]) { gameState.bases[1] = true; gameState.bases[0] = false; }
            }
            return runs;
        }

        // 四球
        function walkBatter() {
            let runs = 0;
            if (gameState.bases[0] && gameState.bases[1] && gameState.bases[2]) {
                runs = 1;
            } else if (gameState.bases[0] && gameState.bases[1]) {
                gameState.bases[2] = true;
            } else if (gameState.bases[0]) {
                gameState.bases[1] = true;
            }
            gameState.bases[0] = true;
            gameState.score += runs;
            resetCount();
            updateDisplay();
        }

        // カウントリセット
        function resetCount() {
            gameState.balls = 0;
            gameState.strikes = 0;
        }

        // アウト記録
        function recordOut() {
            gameState.outs++;
            resetCount();

            if (gameState.outs >= 3) {
                gameState.outs = 0;
                gameState.bases = [false, false, false];
                gameState.inning++;

                if (gameState.inning > 9) {
                    gameState.gameOver = true;
                    showMessage(`ゲーム終了! 最終スコア: ${gameState.score}点 (${gameState.hits}安打)`);
                    elements.readyBtn.disabled = true;
                    elements.readyBtn.textContent = 'ゲーム終了';
                } else {
                    showMessage(`${gameState.inning}回の攻撃!`);
                }
            }
            updateDisplay();
        }

        // 表示更新
        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('hits').textContent = gameState.hits;
            document.getElementById('inning').textContent = gameState.inning;

            // カウント
            const ballDots = document.getElementById('ballDots').children;
            const strikeDots = document.getElementById('strikeDots').children;
            const outDots = document.getElementById('outDots').children;

            for (let i = 0; i < 3; i++) {
                ballDots[i].className = i < gameState.balls ? 'dot ball' : 'dot';
            }
            for (let i = 0; i < 2; i++) {
                strikeDots[i].className = i < gameState.strikes ? 'dot strike' : 'dot';
            }
            for (let i = 0; i < 2; i++) {
                outDots[i].className = i < gameState.outs ? 'dot out' : 'dot';
            }

            // ランナー
            document.getElementById('runner1').className = gameState.bases[0] ? 'runner on-first' : 'runner';
            document.getElementById('runner2').className = gameState.bases[1] ? 'runner on-second' : 'runner';
            document.getElementById('runner3').className = gameState.bases[2] ? 'runner on-third' : 'runner';
        }

        // リセット
        function resetGame() {
            resetState();
            startGame(gameState.difficulty || 'normal');
        }

        function resetState() {
            clearTimeout(pitchTimeout);
            clearTimeout(swingTimeout);
            elements.ball.style.display = 'none';
            elements.hitBall.style.display = 'none';
            elements.resultDisplay.style.display = 'none';
            elements.pitchInfo.style.display = 'none';
        }

        // イベントリスナー
        elements.field.addEventListener('click', handleSwing);
        elements.field.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            handleSwing({ clientX: touch.clientX, clientY: touch.clientY });
        });
    </script>
</body>
</html>
